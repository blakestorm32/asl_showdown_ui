{"version":3,"file":"client-connection-worker.js","names":["socket","serverInfo","reconnectTimeout","queue","self","onmessage","event","_event$data","data","type","server","connectToServer","readyState","WebSocket","OPEN","send","push","close","clearTimeout","port","protocol","url","host","prefix","SockJS","timeout","_unused","replace","onopen","postMessage","_i2","_queue2","length","_socket","msg","e","onclose","onerror","err","_socket2","message"],"sources":["../src/client-connection-worker.ts"],"sourcesContent":["declare const SockJS: any;\nimport type { ServerInfo } from \"./client-main\";\n\nlet socket: WebSocket | null = null;\nlet serverInfo: ServerInfo;\nlet reconnectTimeout: ReturnType<typeof setTimeout> | null = null;\nlet queue: string[] = [];\n\nself.onmessage = (event: MessageEvent) => {\n\tconst { type, server, data } = event.data;\n\tif (type === 'connect') {\n\t\tserverInfo = server;\n\t\tconnectToServer();\n\t} else if (type === 'send') {\n\t\tif (socket && socket.readyState === WebSocket.OPEN) {\n\t\t\tsocket.send(data);\n\t\t} else {\n\t\t\tqueue.push(data);\n\t\t}\n\t} else if (type === 'disconnect') {\n\t\tif (socket) socket.close();\n\t\tif (reconnectTimeout) clearTimeout(reconnectTimeout);\n\t\tsocket = null;\n\t}\n};\n\nfunction connectToServer() {\n\tif (!serverInfo) return;\n\n\tconst port = serverInfo.protocol === 'https' ? '' : `:${serverInfo.port}`;\n\tconst url = `${serverInfo.protocol}://${serverInfo.host}${port}${serverInfo.prefix}`;\n\n\ttry {\n\t\tsocket = new SockJS(url, [], { timeout: 5 * 60 * 1000 });\n\t} catch {\n\t\tsocket = new WebSocket(url.replace('http', 'ws') + '/websocket');\n\t}\n\tif (socket) {\n\t\tsocket.onopen = () => {\n\t\t\tpostMessage({ type: 'connected' });\n\t\t\tfor (const msg of queue) socket?.send(msg);\n\t\t\tqueue = [];\n\t\t};\n\n\t\tsocket.onmessage = (e: MessageEvent) => {\n\t\t\tpostMessage({ type: 'message', data: e.data });\n\t\t};\n\n\t\tsocket.onclose = () => {\n\t\t\tpostMessage({ type: 'disconnected' });\n\t\t\t// scheduleReconnect();\n\t\t};\n\n\t\tsocket.onerror = (err: Event) => {\n\t\t\tpostMessage({ type: 'error', data: (err as any).message || '' });\n\t\t\tsocket?.close();\n\t\t};\n\t\treturn;\n\t}\n\treturn postMessage({ type: 'error' });\n}\n"],"mappings":"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","ignoreList":[]}