{
  auto_https off
  admin off
}

# ASL Play site (standalone deployment)
http://:{$PORT} {
  root * /app/play.pokemonshowdown.com
  encode zstd gzip

  log {
    output stdout
    format console
  }

  ####################################################################
  # Content types / headers
  ####################################################################
  @colors path /colors.json
  header @colors Access-Control-Allow-Origin "*"
  header @colors Access-Control-Allow-Methods "GET,POST,OPTIONS"
  header @colors Access-Control-Allow-Headers "Content-Type, X-Requested-With"

  @nocache path /index.html /preactalpha.html
  header @nocache Cache-Control "max-age=0, no-cache, no-store, must-revalidate"
  header @nocache Pragma "no-cache"
  header @nocache Expires "Wed, 11 Jan 1984 05:00:00 GMT"

  @saferes path_regexp saferes "^/(style/fonts?/.*\\.(eot|svg|ttf|woff2?))$|^/data/.*\\.(js|json)$"
  header @saferes Access-Control-Allow-Origin "*"
  header @saferes Access-Control-Allow-Methods "GET,POST,OPTIONS"
  header @saferes Access-Control-Allow-Headers "Content-Type, X-Requested-With"

  @json5 path *.json5
  header @json5 Content-Type "text/plain; charset=UTF-8"

  ####################################################################
  # Redirects (customized to your services)
  ####################################################################

  # Help/appeal/report pages
  @appeal path_regexp appeal "^/appeals?/?$"
  redir @appeal https://play.pokemonshowdown.com/view-help-request--appeal 302

  @report path_regexp report "^/report/?$"
  redir @report https://play.pokemonshowdown.com/view-help-request--report 302

  @request path_regexp request "^/requesthelp/?$"
  redir @request https://play.pokemonshowdown.com/view-help-request--other 302

  # Smogon-related pages
  @rules path_regexp rules "^/rules?/?$"
  redir @rules https://pokemonshowdown.com/rules 302

  @faq path_regexp faq "^/faq/?$"
  redir @faq https://www.smogon.com/forums/posts/6774128/ 302

  @credits path_regexp credits "^/credits?/?$"
  redir @credits https://pokemonshowdown.com/credits 302

  @privacy path_regexp privacy "^/privacy/?$"
  redir @privacy https://pokemonshowdown.com/privacy 302

  @contact path_regexp contact "^/contact/?$"
  redir @contact https://pokemonshowdown.com/contact 302

  ####################################################################
  # Redirects to your own services
  ####################################################################
  @dexroot path_regexp dexroot "^/dex/?$"
  redir @dexroot https://asl-pokemon-showdown-dex-production.up.railway.app/ 302

  @calc path_regexp calc "^/(damage)?calc/?$"
  redir @calc https://asl-pokemon-showdown-dex-production.up.railway.app/calc 302

  @replays path_regexp replays "^/replays?/?$"
  redir @replays https://asl-pokemon-showdown-client-production.up.railway.app/ 302

  @rshort path_regexp rshort "^/r/?$"
  redir @rshort https://asl-pokemon-showdown-client-production.up.railway.app/ 302

  @rslug path_regexp rslug "^/r/([a-z0-9-]*)$"
  redir @rslug https://asl-pokemon-showdown-client-production.up.railway.app/{re.rslug.1} 302

  @bdate path_regexp bdate "^/battle-([a-z0-9]+-[0-9]{8})$"
  redir @bdate https://asl-pokemon-showdown-client-production.up.railway.app/{re.bdate.1} 302

  @broom path_regexp broom "^/battle-([a-z0-9]+)$"
  redir @broom https://asl-pokemon-showdown-client-production.up.railway.app/{re.broom.1} 302

  ####################################################################
  # Proxy to your local Showdown server (WebSocket + HTTP API)
  ####################################################################
  @showdown path /showdown* /showdown/*
  reverse_proxy @showdown aslpokemonbattling-up-railway-app.internal:8000
  # or if Railway doesnâ€™t give internal DNS, use the public URL (less efficient):
  # reverse_proxy @showdown https://aslpokemonbattling-up-railway-app.up.railway.app

  ####################################################################
  # Sprite rewrites (unchanged)
  ####################################################################
  @xyani path_regexp xyani "^/sprites/xyani(.*)$"
  rewrite @xyani /sprites/ani{re.xyani.1}

  @xydex path_regexp xydex "^/sprites/xydex(.*)$"
  rewrite @xydex /sprites/dex{re.xydex.1}

  @smicons path_regexp smicons "^/sprites/smicons(.*)$"
  rewrite @smicons /sprites/pokemonicons{re.smicons.1}

  ####################################################################
  # Index-page routing
  ####################################################################
  @preact path /preactalpha /preactalpha.html /beta /dev /development /login
  rewrite @preact /preactalpha.html

  @preactPat path_regexp preactPat "^/(preactbeta|beta|dev|development|login|users|dm-[a-z0-9-]+|challenge-[a-z0-9-]+|user-[a-z0-9-]+|viewuser-[a-z0-9-]+|ladder-[a-z0-9-]+)$"
  rewrite @preactPat /preactalpha.html

  @roomid path_regexp roomid "^/([A-Za-z0-9][A-Za-z0-9-]*)$"
  rewrite @roomid /

  ####################################################################
  # Forbidden files
  ####################################################################
  @forbid path /backup/* /.git/* /lib/* /index.template.html /preactalpha.template.html /testclient.html /testclient-beta.html
  respond @forbid 403

  @apple path /apple-touch-icon-precomposed.png
  respond @apple 404

  ####################################################################
  # Default handlers
  ####################################################################
  try_files {path} {path}/ /index.html
  file_server
}
